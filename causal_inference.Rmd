---
title: ""
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover(); 
});
</script>
<style type="text/css">
.title {
  display: none;
}

#getting-started img {
  margin-right: 1px;
}

</style>

<div class="row" style="padding-top: 30px;">
<div class="col-sm-6">

# Balancing Samples in Survey Data

Propensity score matching helps to control for confounded relationships among variables when randomization is not feasible. Especially in observational studies that use administrative data, such as this project involving the <a href = "https://www.opendataphilly.org/" target = "_blank"> Philadelphia School District</a>, sample size representation will affect the balance of matched samples.

### Technical

Data cleaning: tidyverse </br>
Causal Inference: R (MatchIt)

### Sample

Sample code below.


```{r echo=TRUE, message=FALSE, eval=FALSE}

## sample data cleaning code
merged_participation$`YEARS OF SERVICE` <- as.numeric(merged_participation$`YEARS OF SERVICE`)
merged_participation <- merged_participation  %>%
  mutate(strata = case_when(is.na(`YEARS OF SERVICE`) ~"missing",
                            `YEARS OF SERVICE` <= 5 ~ "less than 5",
                            `YEARS OF SERVICE` >5 & `YEARS OF SERVICE` < 10 ~ "5 to less than 10 years",
                            `YEARS OF SERVICE` >=10 & `YEARS OF SERVICE` < 15 ~ "10 to 15 years",
                            `YEARS OF SERVICE` >= 15 ~ "greater than or equal to 15"))

merged_participation <- merged_participation  %>%
  rename("quitdate" = `EMPLOYMENT STATUS EFFECTIVE DATE`,
         "startdate" = `NEW TEACHER HIRE DATE`) %>%
  mutate(retained = ifelse(is.na(`quitdate`), "1", "0"))
#pull out the missingvalues
missing_table <- merged_participation %>%
  filter(strata == "missing")
print(missing_table)
#recode  duplicates
#ID 214280
merged_participation$`startdate`[40338] = (origin = "2004-12-01")
#ID 277504
merged_participation$`startdate`[63771] = (origin = "2010-01-11")
merged_participation$`startdate`[63777] = (origin = "2010-01-11")
merged_participation$`startdate`[63778] = (origin = "2010-01-11")
merged_participation<- merged_participation %>%
  filter(!is.na(startdate))
length(unique(merged_participation$`Deidentified ID`))
#rename
merged_participation <- merged_participation %>%
  rename("Title" = `TITLE`,
         "Gender" = `GEN`,
         "Ethnicity" = `ETHNICITY`,
         "Birth Date" = `BIRTH DATE`,
         "Employee Age" = `EMPLOYEE AGE`,
         "Organization" = `ORGANIZATION`,
         "Retained" = `retained`,
         "Strata" = `strata`,
         "Years of Service" = `YEARS OF SERVICE`)
merged_participation$Strata <- as.factor(merged_participation$Strata)
merged_participation$Strata <- recode_factor(merged_participation$Strata, `1` = "less than 5", `2` = "5 to less than 10 years", `3` = "10 to 15 years", `4` = "greater than or equal to 15")
#save
save(merged_participation, file = "data/merged_participation.Rdata")  
length(unique(merged_participation$`Deidentified ID`))

## sample causal code
set.seed(1731)
# trimming the sample
analysis_data_trimmed <- analysis_data %>%
  filter(YearsOfService %in% c(0:31, 33,34,35,36,37,39))
nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)

```

```{r echo=FALSE, message=FALSE}


#install.packages("MatchIt")
library(MatchIt)
library(tidyverse)
library(kableExtra)
set.seed(1731)
# trimming the sample
analysis_data <- read.csv('data/analysis_data.csv')
analysis_data_trimmed <- analysis_data %>%
  filter(YearsOfService %in% c(0:31, 33,34,35,36,37,39))

nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                   ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
#summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
#summary(model)
library(readr)
percent_balance_improvement <- read_csv("data/percent_balance_improvement.csv")
html_table_width <- function(kable_output, width){
  width_html <- paste0(paste0('<col width="', width, '">'), collapse = "\n")
  sub("<table>", paste0("<table>\n", width_html), kable_output)
}
kable(percent_balance_improvement, escape = FALSE, caption = "Balance is a representation of similarity in the distribution of a covariate among the treatment and the control group. Trimming the sample helped us to arrive at a better percent balance improvement for unrepresented variables.") %>%
  kable_styling("striped", full_width = FALSE, position = "left",
                font_size = 10, latex_options = "scale_down") %>%
  row_spec(c(2:3), color = "white", background = "#00AFBB") %>%
  row_spec(c(7),color = "white", background = "#Fd8453")


```




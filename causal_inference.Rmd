---
title: ""
output: 
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
    code_folding: hide

---

<p>&nbsp;</p>
<p>&nbsp;</p>
## Administrative Data Matching

----

<div class="row">
<div class="col-sm-6">

#### Overview

In experiments where randomization is not feasible, propensity score matching helps to control for confounded relationships. Analysts working in this causal framework often run into a particular issue: sample size affects their ability to arrive at evenly matched samples. This problem is especially prevalent in observational studies which use administrative data. In a project with the <a href = "https://www.opendataphilly.org/" target = "_blank"> Philadelphia School District</a>, we arrive at better percent balance improvement by trimming mis-represented groups.


#### Technical
Data cleaning: tidyverse </br>
Causal Inference: R (MatchIt)

</div>
<div class="col-sm-6">

<a href="https://crumplab.github.io/psyc3400/">
```{r rcourse, out.width=150, echo=F}
knitr::include_graphics("images/philly.jpg")
```
</a>

</div>
</div>

-----

<div class="row">
<div class="col-sm-6">

#### Sample


Sample visualization below. Full project in process.
</div>
<div class="col-sm-6">
```{r echo=TRUE, message=FALSE, eval=FALSE}

## sample data cleaning code
merged_participation$`YEARS OF SERVICE` <- as.numeric(merged_participation$`YEARS OF SERVICE`)
merged_participation <- merged_participation  %>%
  mutate(strata = case_when(is.na(`YEARS OF SERVICE`) ~"missing",
                            `YEARS OF SERVICE` <= 5 ~ "less than 5",
                            `YEARS OF SERVICE` >5 & `YEARS OF SERVICE` < 10 ~ "5 to less than 10 years",
                            `YEARS OF SERVICE` >=10 & `YEARS OF SERVICE` < 15 ~ "10 to 15 years",
                            `YEARS OF SERVICE` >= 15 ~ "greater than or equal to 15"))

merged_participation <- merged_participation  %>%
  rename("quitdate" = `EMPLOYMENT STATUS EFFECTIVE DATE`,
         "startdate" = `NEW TEACHER HIRE DATE`) %>%
  mutate(retained = ifelse(is.na(`quitdate`), "1", "0"))
#pull out the missingvalues
missing_table <- merged_participation %>%
  filter(strata == "missing")
print(missing_table)
#recode  duplicates
#ID 214280
merged_participation$`startdate`[40338] = (origin = "2004-12-01")
#ID 277504
merged_participation$`startdate`[63771] = (origin = "2010-01-11")
merged_participation$`startdate`[63777] = (origin = "2010-01-11")
merged_participation$`startdate`[63778] = (origin = "2010-01-11")
merged_participation<- merged_participation %>%
  filter(!is.na(startdate))
length(unique(merged_participation$`Deidentified ID`))
#rename
merged_participation <- merged_participation %>%
  rename("Title" = `TITLE`,
         "Gender" = `GEN`,
         "Ethnicity" = `ETHNICITY`,
         "Birth Date" = `BIRTH DATE`,
         "Employee Age" = `EMPLOYEE AGE`,
         "Organization" = `ORGANIZATION`,
         "Retained" = `retained`,
         "Strata" = `strata`,
         "Years of Service" = `YEARS OF SERVICE`)
merged_participation$Strata <- as.factor(merged_participation$Strata)
merged_participation$Strata <- recode_factor(merged_participation$Strata, `1` = "less than 5", `2` = "5 to less than 10 years", `3` = "10 to 15 years", `4` = "greater than or equal to 15")
#save
save(merged_participation, file = "data/merged_participation.Rdata")  
length(unique(merged_participation$`Deidentified ID`))

## sample causal code
set.seed(1731)
# trimming the sample
analysis_data_trimmed <- analysis_data %>%
  filter(YearsOfService %in% c(0:31, 33,34,35,36,37,39))
nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                     ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
summary(model)

```

```{r echo=FALSE, message=FALSE}


#install.packages("MatchIt")
library(MatchIt)
library(tidyverse)
library(kableExtra)
set.seed(1731)
# trimming the sample
analysis_data <- read.csv('data/analysis_data.csv')
analysis_data_trimmed <- analysis_data %>%
  filter(YearsOfService %in% c(0:31, 33,34,35,36,37,39))

nearest <- matchit(Participated ~
                     Gender+ Ethnicity + Strata + employeeage+ title_status
                   ,
                   family = "binomial",
                   method = "nearest",
                   caliper = 0.25,
                   data = analysis_data_trimmed)
#summary(nearest)
###plotting these
#plot(nearest)
nearest_matched <- match.data(nearest)
#now perform the statistical analysis
nearest_matched$Participated <- as.factor(nearest_matched$Participated)
model <- glm(Retained ~ Participated, data = nearest_matched,
             family = binomial)
#summary(model)
library(readr)
percent_balance_improvement <- read_csv("data/percent_balance_improvement.csv")
html_table_width <- function(kable_output, width){
  width_html <- paste0(paste0('<col width="', width, '">'), collapse = "\n")
  sub("<table>", paste0("<table>\n", width_html), kable_output)
}
kable(percent_balance_improvement, escape = FALSE) %>%
  kable_styling("striped", full_width = FALSE, position = "left",
                font_size = 10, latex_options = "scale_down") %>%
  row_spec(c(2:3), color = "white", background = "#D6EAF8") %>%
  row_spec(c(7),color = "white", background = "#FAD7A0")


```



